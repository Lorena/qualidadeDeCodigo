Classe NotaFiscal nada coesa.
Um método com muitas funcionalidades.
Para ficar claro o que o método faz foi preciso colocar muitos comentários.